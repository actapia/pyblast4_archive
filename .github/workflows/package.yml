name: package

on:
  workflow_dispatch:
    inputs:
      debug_enabled:
        type: boolean
        description: 'Run the build with tmate debugging enabled (https://github.com/marketplace/actions/debugging-with-tmate)'
        required: false
        default: false

jobs:
  build-linux:
    name: Build on ${{matrix.architecture}} Linux platform
    strategy:
      matrix:
        architecture: [x86_64, aarch64, ppc64le, s390x, i386]
        include:
          - architecture: x86_64
            runner: ubuntu-latest
            binfmt_arch: x86_64
            container: quay.io/pypa/manylinux_2_28_x86_64
            plat: manylinux_2_28_x86_64
            native: true
          - architecture: aarch64
            runner: ubuntu-24.04-arm
            binfmt_arch: aarch64
            container: quay.io/pypa/manylinux_2_28_aarch64
            plat: manylinux_2_28_aarch64
            native: true
          - architecture: ppc64le
            runner: ubuntu-latest
            binfmt_arch: ppc64le
            container: quay.io/pypa/manylinux_2_28_ppc64le
            plat: manylinux_2_28_ppc64le
            native: false
          - architecture: s390x
            runner: ubuntu-latest
            binfmt_arch: s390x
            container: quay.io/pypa/manylinux_2_28_s390x
            plat: manylinux_2_28_s390x
            native: false
          - architecture: i386
            runner: ubuntu-latest
            binfmt_arch: 386
            container: quay.io/pypa/manylinux_2_28_i686
            plat: manylinux_2_28_i686
            native: false

    runs-on: ${{matrix.runner}}
    
    steps:
      - uses: actions/checkout@v5
        
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        if: ${{ ! matrix.native }}
        with:
          platforms: ${{matrix.binfmt_arch}}

      - name: Install podman
        run: sudo apt update && sudo apt install podman

      - name: Clone manylinux_packages repo
        run: >
          git clone https://github.com/actapia/manylinux_packages
          "$HOME"/manylinux_packages

      - name: Start container
        run: >
          echo container_id="$(
          sudo podman run -di
          -v "$(realpath .):/root"
          ${{matrix.container}}
          )" >> "$GITHUB_ENV"
      
      - name: Mount container
        run: >
          echo mount="$(sudo podman mount ${{env.container_id}})"
          >> "$GITHUB_ENV"
      
      - name: Copy repo file to container
        run: >
          sudo cp "$HOME"/manylinux_packages/manylinux_packages.repo
          ${{env.mount}}/etc/yum.repos.d/

      - name: Install RPM dependencies in container
        run: >
          sudo podman exec ${{env.container_id}}
          dnf -y install
          ncbi-cxx-toolkit boost-python-manylinux
          ncbi-cxx-toolkit-devel boost-python-manylinux-devel

      - name: Setup tmate session
        uses: mxschmitt/action-tmate@v3
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.debug_enabled }}        
          

      - name: Build the package for all Python versions
        run: >          
          sudo podman exec -w /root ${{env.container_id}}
          bash manylinux_build.sh

      - name: Repair wheels
        run: >
          sudo podman exec -w /root ${{env.container_id}}
          find wheelhouse -name '*.whl' -exec auditwheel repair {}
          --plat ${{matrix.plat}} -w wheelhouse \;

      - name: Change wheelhouse ownership
        run: >
          sudo chown -R "$USER" wheelhouse

      - name: Make external dep environment
        run: >
          sudo podman exec -w /root ${{env.container_id}}
          /opt/python/cp313-cp313/bin/python -m venv dep_env

      - name: Install auditwheel-get-external-deps
        run: >
          sudo podman exec -w /root ${{env.container_id}}
          dep_env/bin/python -m pip install auditwheel-get-external-deps

      - name: Get dependency packages
        run: >
          sudo podman exec -w /root ${{env.container_id}} bash -c "
          set -o pipefail;
          dep_env/bin/python -m auditwheel-get-external-deps
          --plat ${{matrix.plat}} wheelhouse/* |
          xargs rpm -qf |
          sort -u |
          xargs dnf repoquery --qf '%{NAME}'
          " > linux_deps-${{matrix.architecture}}

      - name: Upload wheels
        id: wheel-upload
        uses: actions/upload-artifact@v4
        with:
          name: wheel_${{matrix.architecture}}
          path: 'wheelhouse/*manylinux*.whl'
          if-no-files-found: error
          retention-days: 1
          overwrite: true

      - name: Upload dependency list
        id: deps-upload
        uses: actions/upload-artifact@v4
        with:
          name: linux_deps-${{matrix.architecture}}
          path: linux_deps-${{matrix.architecture}}
          if-no-files-found: error
          retention-days: 1
          overwrite: true          
    
  build-macos:
    name: Build on macOS
    strategy:
      matrix:
        runner:
          - macos-15-intel
          - macos-15
          - macos-26

        include:
          - runner: macos-15
            codename: Sequoia

          - runner: macos-15-intel
            codename: Sequoia            

          - runner: macos-26
            codename: Tahoe

    runs-on: ${{matrix.runner}}
    steps:
      - uses: actions/checkout@v5

      - name: Install Python 3.13
        run: brew install --overwrite python@3.13

      - name: Tap actapia/cibuildwheel_packages
        run: brew tap actapia/cibuildwheel_packages

      - name: Install boost-python-cibuildwheel
        run: brew install boost-python-cibuildwheel

      - name: Install ncbi-cxx-toolkit
        run: brew install ncbi-cxx-toolkit

      - name: Create a venv
        run: python3.13 -m venv cibuildwheel

      - name: Install cibw-install-pythons
        run: cibuildwheel/bin/python -m pip install cibw-install-pythons

      - name: Install all Python versions
        env:
          CI: 1
          CIBW_CACHE_PATH: /Library/Caches/cibuildwheel
        run: >
          cibuildwheel/bin/python -m cibw-install-pythons macos --ensurepip

      - name: Build the package for all Python versions
        run: zsh macos_build.sh

      - name: Install delocate
        run: cibuildwheel/bin/python -m pip install delocate          

      - name: Delocate wheelhouse
        run: >
          zsh delocate_all.sh cibuildwheel/bin/python wheelhouse
          delocated_wheelhouse |
          xargs -L 1 readlink -f |
          sed "s,^$(brew --prefix)/Cellar/\([^/]*\).*,\1," |
          sort -u > macos_deps-${{matrix.runner}}

      - name: Upload wheels
        id: wheel-upload
        uses: actions/upload-artifact@v4
        with:
          name: wheel_${{matrix.runner}}
          path: 'delocated_wheelhouse/*.whl'
          if-no-files-found: error
          retention-days: 1
          overwrite: true

      - name: Upload dependency list
        id: deps-upload
        uses: actions/upload-artifact@v4
        with:
          name: macos_deps_${{matrix.runner}}
          path: macos_deps-${{matrix.runner}}
          if-no-files-found: error
          retention-days: 1
          overwrite: true
          

        
